# Git Watcher å®¹å™¨æŒç»­è¿è¡Œä¿®å¤

## é—®é¢˜åˆ†æ

åŸå…ˆçš„ watcher å®¹å™¨åœ¨å®‰è£…å®Œä¾èµ–åå°±é€€å‡ºäº†ï¼Œä¸»è¦åŸå› ï¼š

1. **å¯åŠ¨å‘½ä»¤é—®é¢˜**ï¼šåŸæ¥çš„å¯åŠ¨è„šæœ¬ç¼ºå°‘å‰å°è¿è¡Œæœºåˆ¶
2. **é”™è¯¯å¤„ç†ä¸å½“**ï¼šæ²¡æœ‰è¶³å¤Ÿçš„é”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯
3. **å¥åº·æ£€æŸ¥ç¼ºå¤±**ï¼šæ²¡æœ‰åˆé€‚çš„å¥åº·æ£€æŸ¥æœºåˆ¶
4. **é…ç½®æ–‡ä»¶åˆ›å»ºé€»è¾‘**ï¼šä»ç¯å¢ƒå˜é‡åˆ›å»ºé…ç½®æ–‡ä»¶çš„é€»è¾‘ä¸å¤Ÿå¥å£®

## ä¿®å¤å†…å®¹

### 1. æ”¹è¿›å¯åŠ¨è„šæœ¬

- ä½¿ç”¨ `exec` å‘½ä»¤ç¡®ä¿Pythonè¿›ç¨‹åœ¨å‰å°è¿è¡Œ
- æ·»åŠ è¯¦ç»†çš„å¯åŠ¨æ—¥å¿—è¾“å‡º
- æ”¹è¿›é”™è¯¯å¤„ç†å’Œä¾èµ–å®‰è£…æµç¨‹
- æ·»åŠ é…ç½®æ–‡ä»¶æ£€æŸ¥å’Œåˆ›å»ºé€»è¾‘

### 2. æ·»åŠ å¥åº·æ£€æŸ¥

```yaml
# å­˜æ´»æ£€æŸ¥ï¼šç¡®ä¿Pythonè¿›ç¨‹åœ¨è¿è¡Œ
livenessProbe:
  exec:
    command:
    - /bin/sh
    - -c
    - "ps aux | grep -v grep | grep 'start_watcher.py' || exit 1"
  initialDelaySeconds: 30
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 3

# å°±ç»ªæ£€æŸ¥ï¼šç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨
readinessProbe:
  exec:
    command:
    - /bin/sh  
    - -c
    - "test -f /app/data/watcher-state.json || test -f $CONFIG_PATH"
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
```

### 3. æ”¹è¿›é…ç½®ç®¡ç†

- æ·»åŠ  GitHub token æ”¯æŒ
- ç®€åŒ–ä»“åº“é…ç½®
- å¢åŠ èµ„æºé™åˆ¶ä»¥é˜²æ­¢OOM

### 4. é‡å¯ç­–ç•¥

```yaml
restartPolicy: Always
```

## éƒ¨ç½²æ­¥éª¤

1. **è®¾ç½®GitHub Token**ï¼š
   ```bash
   # ç¼–è¾‘Secretï¼Œæ›¿æ¢ä¸ºçœŸå®çš„GitHub token
   kubectl edit secret git-watcher-config -n nokube-system
   ```

2. **åº”ç”¨é…ç½®**ï¼š
   ```bash
   kubectl apply -f watcher-deployment-paserver.yaml
   ```

3. **æ£€æŸ¥çŠ¶æ€**ï¼š
   ```bash
   # æŸ¥çœ‹PodçŠ¶æ€
   kubectl get pods -n nokube-system -l app=git-watcher
   
   # æŸ¥çœ‹æ—¥å¿—
   kubectl logs -n nokube-system -l app=git-watcher -f
   ```

## ç›‘æ§æ£€æŸ¥

å®¹å™¨å¯åŠ¨åä¼šæ˜¾ç¤ºä»¥ä¸‹æ—¥å¿—ï¼š

```
ğŸš€ å¯åŠ¨ Git Watcher å®¹å™¨...
ğŸ“¥ å…‹éš† nokube ä»“åº“...
ğŸ“¦ å®‰è£…Pythonä¾èµ–...
ğŸ” æ£€æŸ¥é…ç½®æ–‡ä»¶: /app/config/repos.yaml
ğŸ“‹ é…ç½®æ–‡ä»¶å†…å®¹é¢„è§ˆ:
ğŸ¯ å¯åŠ¨ Git ä»“åº“ç›‘æ§å™¨...
ğŸš€ å¯åŠ¨ Git ä»“åº“ç›‘æ§å™¨
ğŸ‘€ å¼€å§‹ç›‘æ§ä»“åº“: pa-server-sing-box (é—´éš”: 300s)
âœ… ç›‘æ§ 1 ä¸ªä»“åº“
```

## ä¸»è¦æ”¹è¿›ç‚¹

1. **æŒç»­è¿è¡Œ**ï¼šä½¿ç”¨ `exec` ç¡®ä¿ä¸»è¿›ç¨‹æŒç»­è¿è¡Œ
2. **å¥å£®æ€§**ï¼šæ·»åŠ å¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨é‡å¯
3. **å¯è§‚æµ‹æ€§**ï¼šè¯¦ç»†çš„å¯åŠ¨æ—¥å¿—å’ŒçŠ¶æ€è¾“å‡º
4. **é…ç½®çµæ´»æ€§**ï¼šæ”¯æŒç¯å¢ƒå˜é‡å’ŒSecreté…ç½®
5. **èµ„æºç®¡ç†**ï¼šåˆç†çš„èµ„æºé™åˆ¶å’Œè¯·æ±‚

## æ³¨æ„äº‹é¡¹

- éƒ¨ç½²å‰è¯·æ›¿æ¢ `github-token` ä¸ºçœŸå®çš„GitHubè®¿é—®ä»¤ç‰Œ
- ç¡®ä¿ `nokube-system` å‘½åç©ºé—´å­˜åœ¨
- ç›‘æ§å®¹å™¨æ—¥å¿—ç¡®ä¿æ­£å¸¸è¿è¡Œ
